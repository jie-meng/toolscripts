#!/bin/bash

# Image Watermark Removal Script
# Remove watermarks from images using ImageMagick

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
POSITION="bottom-right"
SIZE="250,100"
OUTPUT=""
IMAGES=()

# Function to show usage
show_usage() {
    echo "======================================================================"
    echo "Image Watermark Removal Tool"
    echo "======================================================================"
    echo
    echo "Usage:"
    echo "  $0 <image_files...> [options]"
    echo
    echo "Options:"
    echo "  -p, --position <pos>    Watermark position (default: bottom-right)"
    echo "                          Options: top-left, top-right, bottom-left, bottom-right"
    echo "  -s, --size <w,h>        Watermark size as width,height in pixels (default: 250,100)"
    echo "  -o, --output <file>     Output file (only for single image processing)"
    echo "  -h, --help              Show this help message"
    echo
    echo "Examples:"
    echo "  # Process with default settings (bottom-right, 250x100px)"
    echo "  $0 image.jpg"
    echo
    echo "  # Process multiple images"
    echo "  $0 cat.jpg dog.jpg photo.png"
    echo
    echo "  # Specify watermark position"
    echo "  $0 image.jpg -p top-left"
    echo
    echo "  # Specify watermark size"
    echo "  $0 image.jpg -s 300,120"
    echo
    echo "  # Specify output file"
    echo "  $0 input.jpg -o output.jpg"
    echo
    echo "  # Full example"
    echo "  $0 photo.jpg -p bottom-right -s 300,120 -o clean.jpg"
    echo
    echo "  # Batch processing"
    echo "  $0 *.jpg -s 280,100"
    echo
    echo "Watermark Positions:"
    echo "  top-left      Remove watermark from top-left corner"
    echo "  top-right     Remove watermark from top-right corner"
    echo "  bottom-left   Remove watermark from bottom-left corner"
    echo "  bottom-right  Remove watermark from bottom-right corner (default)"
    echo
}

# Check if ImageMagick is installed
check_imagemagick() {
    if ! command -v magick &> /dev/null; then
        echo -e "${RED}Error: ImageMagick (magick command) not found${NC}"
        echo "Please install ImageMagick first: brew install imagemagick"
        exit 1
    fi
}

# Remove watermark from image
remove_watermark() {
    local input_image="$1"
    local output_image="$2"
    local position="$3"
    local width="$4"
    local height="$5"
    
    # Check if input file exists
    if [[ ! -f "$input_image" ]]; then
        echo -e "${RED}Error: File not found - $input_image${NC}"
        return 1
    fi
    
    # Generate output filename if not specified
    if [[ -z "$output_image" ]]; then
        local filename="${input_image%.*}"
        local extension="${input_image##*.}"
        output_image="${filename}_no_watermark.${extension}"
    fi
    
    echo -e "${BLUE}Processing:${NC} $input_image"
    echo -e "${BLUE}Output:${NC} $output_image"
    echo -e "${BLUE}Watermark position:${NC} $position, ${BLUE}size:${NC} ${width}x${height}px"
    
    # Get image dimensions
    local dimensions
    dimensions=$(magick identify -format '%w %h' "$input_image")
    local img_width=$(echo "$dimensions" | cut -d' ' -f1)
    local img_height=$(echo "$dimensions" | cut -d' ' -f2)
    echo -e "${BLUE}Original size:${NC} ${img_width}x${img_height}"
    
    # Calculate crop dimensions based on watermark position
    local crop_geometry
    local gravity
    local new_width
    local new_height
    
    case "$position" in
        bottom-right|bottom-left)
            # Remove from bottom
            new_width=$img_width
            new_height=$((img_height - height))
            crop_geometry="${new_width}x${new_height}+0+0"
            gravity="North"
            ;;
        top-right|top-left)
            # Remove from top
            new_width=$img_width
            new_height=$((img_height - height))
            crop_geometry="${new_width}x${new_height}+0+${height}"
            gravity="South"
            ;;
        *)
            echo -e "${RED}Error: Invalid position '$position'${NC}"
            echo "Use: top-left, top-right, bottom-left, bottom-right"
            return 1
            ;;
    esac
    
    # Crop the image to remove watermark
    if magick "$input_image" -gravity "$gravity" -crop "$crop_geometry" +repage "$output_image" 2>/dev/null; then
        echo -e "${GREEN}✓ Successfully created: $output_image${NC}"
        echo -e "  ${BLUE}New size:${NC} ${new_width}x${new_height}"
        return 0
    else
        echo -e "${RED}✗ Processing failed${NC}"
        return 1
    fi
}

# Parse command line arguments
parse_args() {
    if [[ $# -eq 0 ]]; then
        echo -e "${RED}Error: No input files specified${NC}\n"
        show_usage
        exit 1
    fi
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -p|--position)
                POSITION="$2"
                shift 2
                ;;
            -s|--size)
                SIZE="$2"
                shift 2
                ;;
            -o|--output)
                OUTPUT="$2"
                shift 2
                ;;
            -*)
                echo -e "${RED}Error: Unknown option: $1${NC}\n"
                show_usage
                exit 1
                ;;
            *)
                IMAGES+=("$1")
                shift
                ;;
        esac
    done
    
    # Check if images array is empty
    if [[ ${#IMAGES[@]} -eq 0 ]]; then
        echo -e "${RED}Error: No input files specified${NC}\n"
        show_usage
        exit 1
    fi
    
    # Validate output option
    if [[ -n "$OUTPUT" && ${#IMAGES[@]} -gt 1 ]]; then
        echo -e "${YELLOW}Warning: -o/--output option ignored when processing multiple images${NC}"
        OUTPUT=""
    fi
}

# Main function
main() {
    echo "======================================================================"
    echo "Image Watermark Removal Tool"
    echo "======================================================================"
    echo
    
    # Check ImageMagick installation
    check_imagemagick
    
    # Parse arguments
    parse_args "$@"
    
    # Parse size parameter
    IFS=',' read -r WIDTH HEIGHT <<< "$SIZE"
    
    # Validate size values
    if [[ ! "$WIDTH" =~ ^[0-9]+$ ]] || [[ ! "$HEIGHT" =~ ^[0-9]+$ ]]; then
        echo -e "${RED}Error: Invalid size format. Use: -s width,height (e.g., -s 250,100)${NC}"
        exit 1
    fi
    
    echo -e "Will process ${#IMAGES[@]} image(s)\n"
    
    # Process each image
    local success_count=0
    for image in "${IMAGES[@]}"; do
        if [[ ! -f "$image" ]]; then
            echo -e "${YELLOW}⚠ Skipping non-existent file: $image${NC}\n"
            continue
        fi
        
        local output_file=""
        if [[ -n "$OUTPUT" && ${#IMAGES[@]} -eq 1 ]]; then
            output_file="$OUTPUT"
        fi
        
        if remove_watermark "$image" "$output_file" "$POSITION" "$WIDTH" "$HEIGHT"; then
            ((success_count++))
        fi
        echo
    done
    
    echo "======================================================================"
    echo -e "${GREEN}Complete! Successfully processed $success_count/${#IMAGES[@]} image(s)${NC}"
    echo "======================================================================"
}

# Run main function
main "$@"
